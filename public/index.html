<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <title>Chat Room</title>
  <style>
    :root {
      --bg-color: #fff;
      --text-color: #000;
      --border-color: #ccc;
      --status-color: #333;
      --system-msg-color: #888;
      --input-bg: #fff;
      --input-text: #000;
    }
    body.dark {
      --bg-color: #121212;
      --text-color: #eee;
      --border-color: #555;
      --status-color: #aaa;
      --system-msg-color: #aaa;
      --input-bg: #222;
      --input-text: #eee;
    }
    body {
      font-family: Arial, sans-serif;
      max-width: 700px;
      margin: 2rem auto;
      background-color: var(--bg-color);
      color: var(--text-color);
      transition: background-color 0.3s, color 0.3s;
    }
    #login, #register, #chat {
      border: 1px solid var(--border-color);
      padding: 1rem;
      border-radius: 5px;
      background-color: var(--bg-color);
      margin-bottom: 1rem;
    }
    #messages {
      border: 1px solid var(--border-color);
      height: 300px;
      overflow-y: auto;
      padding: 10px;
      margin-bottom: 1rem;
      background-color: var(--bg-color);
      color: var(--text-color);
      white-space: pre-wrap;
    }
    #input {
      width: 100%;
      padding: 10px;
      font-size: 1rem;
      background-color: var(--input-bg);
      color: var(--input-text);
      border: 1px solid var(--border-color);
      border-radius: 4px;
    }
    .hidden { display: none; }
    .system-message {
      font-style: italic;
      color: var(--system-msg-color);
    }
    #darkModeToggle, #muteToggle {
      margin: 0.5rem 0.5rem 1rem 0;
      padding: 0.5rem 1rem;
      cursor: pointer;
      border: 1px solid var(--border-color);
      background-color: var(--bg-color);
      color: var(--text-color);
      border-radius: 4px;
      user-select: none;
    }
    #darkModeToggle:hover, #muteToggle:hover {
      background-color: var(--border-color);
      color: var(--bg-color);
    }
    #userList {
      margin-bottom: 1rem;
    }
    .user-entry {
      margin-right: 10px;
      display: inline-block;
      cursor: pointer;
    }
    .user-entry:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div id="login">
    <h2>Login</h2>
    <input id="loginUsername" placeholder="Username" autocomplete="username" /><br /><br />
    <input id="loginPassword" type="password" placeholder="Password" autocomplete="current-password" /><br /><br />
    <button id="loginBtn">Login</button>
    <p>Don't have an account? <a href="#" id="showRegisterLink">Register here</a></p>
  </div>

  <div id="register" class="hidden">
    <h2>Register</h2>
    <input id="regUsername" placeholder="Username" autocomplete="username" /><br /><br />
    <input id="regPassword" type="password" placeholder="Password" autocomplete="new-password" /><br /><br />
    <button id="registerBtn">Register</button>
    <p>Already have an account? <a href="#" id="showLoginLink">Login here</a></p>
  </div>

  <div id="chat" class="hidden">
    <button id="darkModeToggle">Toggle Dark Mode</button>
    <button id="muteToggle">Toggle Sound</button>
    <div id="status"></div>
    <div id="userList"></div>
    <div id="messages"></div>
    <input id="input" placeholder="Type a message or command..." autocomplete="off" />
  </div>

  <script>
    // Get elements
    const loginBox = document.getElementById('login');
    const registerBox = document.getElementById('register');
    const chatBox = document.getElementById('chat');
    const messages = document.getElementById('messages');
    const input = document.getElementById('input');
    const status = document.getElementById('status');
    const userList = document.getElementById('userList');
    const loginBtn = document.getElementById('loginBtn');
    const registerBtn = document.getElementById('registerBtn');
    const showRegisterLink = document.getElementById('showRegisterLink');
    const showLoginLink = document.getElementById('showLoginLink');
    const darkModeToggle = document.getElementById('darkModeToggle');
    const muteToggle = document.getElementById('muteToggle');

    let username = "";
    let color = "#000000";
    let isMuted = false;

    // Create WebSocket (adjust ws url to ws://localhost:3000 or your server)
    const loc = window.location;
    let wsProtocol = (loc.protocol === 'https:') ? 'wss://' : 'ws://';
    const ws = new WebSocket(wsProtocol + loc.hostname + ':3000');

    // Sounds (you can replace or comment out if you don't have these files)
    const joinSound = new Audio('join.mp3');
    const messageSound = new Audio('message.mp3');

    function tryPlay(sound) {
      if (!isMuted) {
        sound?.play?.().catch(() => {});
      }
    }

    function toggleMute() {
      isMuted = !isMuted;
      muteToggle.textContent = isMuted ? 'Unmute Sound' : 'Mute Sound';
    }

    function toggleDarkMode() {
      document.body.classList.toggle('dark');
    }

    function showMessage(text, col = null, isSystem = false) {
      const el = document.createElement('div');
      el.textContent = text;
      if (isSystem) {
        el.className = 'system-message';
        tryPlay(joinSound);
      } else if (col) {
        el.style.color = col;
        tryPlay(messageSound);
      }
      messages.appendChild(el);
      messages.scrollTop = messages.scrollHeight;
    }

    function handleKey(e) {
      if (e.key === 'Enter') {
        const text = input.value.trim();
        if (!text) return;
        if (text.startsWith('/color ')) {
          const newColor = text.split(' ')[1];
          if(/^#([0-9A-F]{3}){1,2}$/i.test(newColor)) {
            color = newColor;
            ws.send(JSON.stringify({ type: 'colorchange', color }));
            showMessage(`You changed your color to ${color}`, color, true);
          } else {
            showMessage('Invalid color format. Use hex like #ff0000', null, true);
          }
        } else if (text === '/help') {
          showMessage(`Commands:\n/help - Show commands\n/color #hex - Change name color\n/users - List users`, null, true);
        } else {
          ws.send(JSON.stringify({ type: 'message', message: text }));
          showMessage(`${username}: ${text}`, color);
        }
        input.value = '';
      }
    }

    function login() {
      const user = document.getElementById('loginUsername').value.trim();
      const pass = document.getElementById('loginPassword').value.trim();
      if (!user || !pass) {
        alert('Please enter username and password');
        return;
      }
      ws.send(JSON.stringify({ type: 'login', username: user, password: pass }));
    }

    function register() {
      const user = document.getElementById('regUsername').value.trim();
      const pass = document.getElementById('regPassword').value.trim();
      if (!user || !pass) {
        alert('Please enter username and password');
        return;
      }
      ws.send(JSON.stringify({ type: 'register', username: user, password: pass }));
    }

    function showRegister() {
      loginBox.classList.add('hidden');
      registerBox.classList.remove('hidden');
      chatBox.classList.add('hidden');
    }

    function showLogin() {
      loginBox.classList.remove('hidden');
      registerBox.classList.add('hidden');
      chatBox.classList.add('hidden');
    }

    // Event listeners
    loginBtn.addEventListener('click', login);
    registerBtn.addEventListener('click', register);
    showRegisterLink.addEventListener('click', e => { e.preventDefault(); showRegister(); });
    showLoginLink.addEventListener('click', e => { e.preventDefault(); showLogin(); });
    darkModeToggle.addEventListener('click', toggleDarkMode);
    muteToggle.addEventListener('click', toggleMute);
    input.addEventListener('keydown', handleKey);

    ws.onopen = () => {
      status.textContent = 'Connected to server';
    };

    ws.onclose = () => {
      status.textContent = 'Disconnected from server';
      loginBox.classList.remove('hidden');
      registerBox.classList.add('hidden');
      chatBox.classList.add('hidden');
      showMessage('Disconnected from server', null, true);
    };

    ws.onmessage = (event) => {
      const msg = JSON.parse(event.data);

      if (msg.type === 'login') {
        if (msg.success) {
          username = document.getElementById('loginUsername').value.trim();
          color = msg.color || '#000000';
          loginBox.classList.add('hidden');
          registerBox.classList.add('hidden');
          chatBox.classList.remove('hidden');
          messages.innerHTML = '';
          showMessage('Welcome to the chat, ' + username, null, true);
        } else {
          alert('Login failed: ' + msg.message);
        }
      } else if (msg.type === 'register') {
        if (msg.success) {
          alert('Registration successful! Please login.');
          showLogin();
        } else {
          alert('Registration failed: ' + msg.message);
        }
      } else if (msg.type === 'message') {
        showMessage(`${msg.username}: ${msg.message}`, msg.color);
      } else if (msg.type === 'system') {
        showMessage(msg.message, null, true);
      } else if (msg.type === 'userlist') {
        userList.innerHTML = 'Users: ' + msg.users.map(u => `<span style="color:${u.color}">${u.username}</span>`).join(', ');
      }
    };
  </script>
</body>
</html>
